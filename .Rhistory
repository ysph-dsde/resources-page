}
# Process the records and generate citations
pmids <- initial_search$ids
all_citations <- process_records(pmids, affiliation)
return(list(citations = all_citations, query = query_term))
}
get_citations(
keywords = c("National Health and Nutrition Examination Survey", "NHANES"),
affiliation = "Yale School of Public Health"
)
get_citations(
doi = c("10.3390/toxics8040125", "10.2105/AJPH.2021.306517"),
affiliation = "Yale School of Public Health")
get_citations <- function(keywords = NULL, affiliation = NULL, doi = NULL, start_years = 5, increment_years = 5, max_range_years = 25, max_results = 1000) {
#' @description
#' Searches for citations in PubMed using specified keywords, affiliation, DOI, and
#' a date range. The function dynamically adjusts the search range if no
#' records are found, incrementing the range up to a specified maximum. It
#' fetches detailed records, extracts author affiliations, and formats the
#' citations while highlighting authors from a specified affiliation.
#'
#' @param keywords A string or vector of strings specifying the keywords to
#'                 search within the Title/Abstract fields. If a vector is
#'                 provided, each keyword will be searched with "OR" operator.
#'                 If a single string with keywords separated by "AND" is
#'                 provided, it will be searched together.
#' @param affiliation A string specifying the affiliation to include in the
#'                    search term. If NULL, this parameter is ignored.
#' @param doi A string or vector of strings specifying the DOI to search for.
#'            If provided, other parameters are ignored.
#' @param start_years An integer specifying the initial number of years to
#'                    include in the search range. Default is 5 years.
#' @param increment_years An integer specifying the increment in years if no
#'                        records are found initially. Default is 5 years.
#' @param max_range_years An integer specifying the maximum number of past
#'                        years to include in the search range. Default is 25
#'                        years.
#' @param max_results An integer specifying the maximum number of records to
#'                    fetch in the search. Default is 1000.
#'
#' @return A list containing the formatted citations and the final search
#'         query used. If no records are found, a message indicating no
#'         publications are found within the range.
#'
#' @examples
#' # Fetching citations with specified parameters
#' citations_output <- get_citations(keywords = "NHANES", affiliation = "Yale School of Public Health", start_years = 5)
fetch_detailed_metadata <- function(pmid) {
# Fetch detailed summary for each PubMed ID (PMID)
summary <- tryCatch({
entrez_summary(db = "pubmed", id = pmid)
}, error = function(e) {
message('Error during entrez_summary:', '\n', e)
return(NULL)
})
if (is.null(summary)) {
return(list(journal = "Journal not available.",
epub_date = "Date not available.",
doi = "DOI not available.",
uid = pmid))
} else {
return(list(journal = summary$fulljournalname %||% "Journal not available.",
epub_date = summary$epubdate %||% summary$pubdate %||% "Date not available.",
doi = summary$elocationid %||% "DOI not available.",
uid = summary$uid))
}
}
process_records <- function(initial_search, affiliation = NULL) {
if (is.null(initial_search) || length(initial_search$ids) == 0) {
return(NULL)
}
# Grab PubMed IDs (PMIDs)
pmids <- initial_search$ids
# Fetch detailed PubMed records
xml_data <- fetch_detailed_pubmed_records(initial_search)
author_affiliation <- extract_author_affiliations(xml_data)
# Initialize the citations vector
citations <- vector('character', length(author_affiliation))
# Loop through each article to extract relevant details and format the citation
for (ii in seq_along(author_affiliation)) {
article <- author_affiliation[[ii]]
title <- article$title
pmid <- article$pmid
authors_info <- article$authors
# Format author names, bolding those affiliated with the specified institution (if affiliation is not NULL)
authors <- sapply(authors_info, function(author) {
name <- paste(author$fore_name, author$last_name)
if (!is.null(affiliation) && !is.null(author$affiliations) && any(grepl(affiliation, author$affiliations))) {
name <- paste0("<strong>", name, "</strong>")  # Use HTML for bold text
}
return(name)
})
authors <- paste(authors, collapse = ', ')
# Fetch detailed metadata
publication <- fetch_detailed_metadata(pmid)
pmid_with_text <- glue('PMID: {publication$uid}')
title_hyperlink <- glue('<a href="https://pubmed.ncbi.nlm.nih.gov/{publication$uid}/">{title}</a>')
citation <- paste0(
title_hyperlink, '<br>',
authors, '<br>',
publication$journal, ' ',
publication$epub_date, ' ',
publication$doi, '<br>',
pmid_with_text
)
citations[ii] <- citation
}
return(citations)
}
if (!is.null(doi)) {
all_citations <- vector('list', length(doi))
all_queries <- vector('character', length(doi))
for (i in seq_along(doi)) {
query_term <- paste0(doi[i], "[doi]")
initial_search <- tryCatch({
entrez_search(db = 'pubmed', term = query_term, retmax = max_results, use_history = TRUE)
}, error = function(e) {
message('Error during entrez_search:', '\n', e)
return(NULL)
})
citations <- process_records(initial_search, affiliation)
if (!is.null(citations)) {
all_citations[[i]] <- citations
}
all_queries[i] <- query_term
}
all_citations <- unlist(all_citations, recursive = FALSE)
if (length(all_citations) == 0) {
return(list(citations = "No publications found.", query = all_queries))
} else {
return(list(citations = all_citations, query = all_queries))
}
} else if (!is.null(keywords)) {
current_year <- as.numeric(format(Sys.Date(), "%Y"))
# Initialize search parameters
years <- start_years
records_found <- FALSE
initial_search <- NULL
# Loop through search attempts, incrementing the year range until records are found or the maximum range is reached
while (years <= max_range_years && !records_found) {
query_term <- build_search_query(keywords, affiliation, years)
# Initial search on PubMed
initial_search <- tryCatch({
entrez_search(db = 'pubmed', term = query_term, retmax = max_results, use_history = TRUE)
}, error = function(e) {
message('Error during entrez_search:', '\n', e)
return(NULL)
})
records_found <- (!is.null(initial_search) && length(initial_search$ids) > 0)
if (!records_found) {
years <- years + increment_years
}
}
# Check if no records were found after exhausting the date range
if (is.null(initial_search) || length(initial_search$ids) == 0) {
return(list(citations = paste0('No publications found in the last ', max_range_years, " years."), query = query_term))
}
# Process the records and generate citations
all_citations <- process_records(initial_search, affiliation)
return(list(citations = all_citations, query = query_term))
} else {
stop("Either 'keywords' or 'doi' must be provided.")
}
}
get_citations(
keywords = c("National Health and Nutrition Examination Survey", "NHANES"),
affiliation = "Yale School of Public Health"
)
get_citations(
doi = c("10.3390/toxics8040125", "10.2105/AJPH.2021.306517"),
affiliation = "Yale School of Public Health")
# Import necessary libraries
suppressPackageStartupMessages({
library("stringr")
library("htmltools")
library("glue")
library("rentrez")
library("xml2")
library("clipr")
})
"%!in%" <- function(x,y)!("%in%"(x,y))
# Load in the functions.
source('./PubMed Search_Functions.R')
get_citations(
keywords = c("National Health and Nutrition Examination Survey", "NHANES"),
affiliation = "Yale School of Public Health"
)
get_citations(
doi = c("10.3390/toxics8040125", "10.2105/AJPH.2021.306517"),
affiliation = "Yale School of Public Health")
# Condition the output based on presence of articles.
citations_html <- make_pub_list(citations)
# Fetch and format the citations.
citations <- get_citations(
doi = c("10.3390/toxics8040125", "10.2105/AJPH.2021.306517"),
affiliation = "Yale School of Public Health")
# Fetch and format the citations.
citations <- get_citations(
doi = c("10.3390/toxics8040125", "10.2105/AJPH.2021.306517"),
affiliation = "Yale School of Public Health")
# Condition the output based on presence of articles.
citations_html <- make_pub_list(citations)
build_search_query(
keywords = c("National Health and Nutrition Examination Survey", "NHANES"),
affiliation = "Yale School of Public Health", years = 5)
update.packages(checkBuilt = TRUE)
update.packages(checkBuilt = TRUE)
renv::snapshot(prompt = FALSE)
citations_html
all_keywords_or <- build_search_query(
keywords = c("Merative's MarketScan", "Merative AND MarketScan", "MarketScan"),
affiliation = "Yale School of Public Health", years = 5)
build_search_query(
keywords = c("Merative's MarketScan", "Merative AND MarketScan", "MarketScan"),
affiliation = "Yale School of Public Health", years = 5)
build_search_query(
keywords = c("Merative's MarketScan", "Merative AND MarketScan"),
affiliation = "Yale School of Public Health", years = 5)
build_search_query(
keywords = c("Merative's MarketScan", "Merative AND MarketScan"),
affiliation = "Yale School of Public Health", years = 25)
build_search_query(
keywords = c("Merative's MarketScan", "Merative AND MarketScan", "MarketScan"),
affiliation = "Yale School of Public Health", years = 5)
build_search_query(
keywords = c("National Health and Nutrition Examination Survey", "NHANES"),
affiliation = "Yale School of Public Health", years = 5)
build_search_query(
keywords = c("National Health and Nutrition Examination Survey AND NHANES"),
affiliation = "Yale School of Public Health", years = 5)
build_search_query(
keywords = c("National Health and Nutrition Examination Survey", "NHANES"),
affiliation = "Yale School of Public Health", years = 5)
build_search_query(
keywords = c("All of Us", "Merative AND MarketScan", "MarketScan"),
affiliation = "Yale School of Public Health", years = 5)
build_search_query(
keywords = c("All of Us"),
affiliation = "Yale School of Public Health", years = 5)
# Fetch and format the citations.
citations <- get_citations(
doi = c("10.1093/jamia/ocae098", "10.14336/AD.2025.0754", "10.1101/2024.10.28.24316286"),
affiliation = c("Yale School of Public Health", "ale University")
)
# Load in the functions.
source('./PubMed Search_Functions.R')
# Fetch and format the citations.
citations <- get_citations(
doi = c("10.1093/jamia/ocae098", "10.14336/AD.2025.0754", "10.1101/2024.10.28.24316286"),
affiliation = c("Yale School of Public Health", "ale University")
)
source('./PubMed Search_Functions.R')
source('./PubMed Search_Functions.R')
# Load in the functions.
source('./PubMed Search_Functions.R')
# Load in the functions.
source('./PubMed Search_Functions.R')
# Load in the functions.
source('./PubMed Search_Functions.R')
# Fetch and format the citations.
citations <- get_citations(
doi = c("10.1093/jamia/ocae098", "10.14336/AD.2025.0754", "10.1101/2024.10.28.24316286"),
affiliation = c("Yale School of Public Health", "ale University")
)
# Condition the output based on presence of articles.
citations_html <- make_pub_list(citations)
# Condition the output based on presence of articles.
citations_html <- make_pub_list(citations)
if(!any(str_detect(citations$citations, "No publications"))) {
citation_length <- length(citations$citations)
citation_date   <- str_match(citations$query, "\\((\\d{4}):(\\d{4})\\[dp\\]\\)")[,2]
} else {
citation_length <- 0
citation_date   <- as.numeric(format(Sys.Date(), "%Y")) - as.numeric(str_extract("No publications found in the last 25 years.", "[0-9]{2}"))
}
citations_html
# Fetch and format the citations.
citations <- get_citations(
doi = c("10.1093/jamia/ocae098", "10.14336/AD.2025.0754", "10.1101/2024.10.28.24316286"),
affiliation = c("Yale School of Public Health", "Yale University")
)
# Condition the output based on presence of articles.
citations_html <- make_pub_list(citations)
citations_html
citations
# Fetch and format the citations.
citations <- get_citations(
doi = c("10.1093/jamia/ocae098", "10.14336/AD.2025.0754", "10.1101/2024.10.28.24316286"),
affiliation = c("Yale School of Public Health", "University of Michigan")
)
# Fetch and format the citations.
citations <- get_citations(
doi = c("10.1093/jamia/ocae098", "10.14336/AD.2025.0754", "10.1101/2024.10.28.24316286"),
affiliation = c("Yale School of Public Health", "University of Michigan")
)
make_pub_list(citations)
# Fetch and format the citations.
citations <- get_citations(
doi = c("10.1093/jamia/ocae098", "10.14336/AD.2025.0754", "10.1101/2024.10.28.24316286"),
affiliation = c("Yale School of Public Health", "Yale University", "University of Michigan")
)
make_pub_list(citations)
get_citations <- function(keywords = NULL, affiliations = NULL, highlight_names = NULL, doi = NULL, start_years = 5, increment_years = 5, max_range_years = 25, max_results = 1000) {
#' @description
#' Searches for citations in PubMed using specified keywords, affiliations, highlight names, DOI, and a date range.
#' The function dynamically adjusts the search range if no records are found, incrementing the range up to a specified maximum.
#' It fetches detailed records, extracts author affiliations, and formats the citations while highlighting authors from specified
#' affiliations and specific names.
#'
#' @param keywords A string or vector of strings specifying the keywords to
#'                 search within the Title/Abstract fields. If a vector is
#'                 provided, each keyword will be searched with "OR" operator.
#'                 If a single string with keywords separated by "AND" is
#'                 provided, it will be searched together.
#' @param affiliations A string or vector of strings specifying the affiliations
#'                     to include in the search term. If NULL, this parameter
#'                     is ignored.
#' @param highlight_names A vector of strings specifying specific author names to be highlighted. If NULL, this parameter is ignored.
#' @param doi A string or vector of strings specifying the DOI to search for.
#'            If provided, other parameters are ignored.
#' @param start_years An integer specifying the initial number of years to
#'                    include in the search range. Default is 5 years.
#' @param increment_years An integer specifying the increment in years if no
#'                        records are found initially. Default is 5 years.
#' @param max_range_years An integer specifying the maximum number of past
#'                        years to include in the search range. Default is 25
#'                        years.
#' @param max_results An integer specifying the maximum number of records to
#'                    fetch in the search. Default is 1000.
#'
#' @return A list containing the formatted citations and the final search
#'         query used. If no records are found, a message indicating no
#'         publications are found within the range.
#'
#' @examples
#' # Fetching citations with specified parameters
#' citations_output <- get_citations(keywords = "NHANES", affiliations = c("Yale School of Public Health", "Harvard Medical School"), highlight_names = c("John Doe", "Jane Smith"), start_years = 5)
fetch_detailed_metadata <- function(pmid) {
# Fetch detailed summary for each PubMed ID (PMID)
summary <- tryCatch({
entrez_summary(db = "pubmed", id = pmid)
}, error = function(e) {
message('Error during entrez_summary:', '\n', e)
return(NULL)
})
if (is.null(summary)) {
return(list(journal = "Journal not available.",
epub_date = "Date not available.",
doi = "DOI not available.",
uid = pmid))
} else {
return(list(journal = summary$fulljournalname %||% "Journal not available.",
epub_date = summary$epubdate %||% summary$pubdate %||% "Date not available.",
doi = summary$elocationid %||% "DOI not available.",
uid = summary$uid))
}
}
process_records <- function(initial_search, affiliations = NULL, highlight_names = NULL) {
if (is.null(initial_search) || length(initial_search$ids) == 0) {
return(NULL)
}
# Grab PubMed IDs (PMIDs)
pmids <- initial_search$ids
# Fetch detailed PubMed records
xml_data <- fetch_detailed_pubmed_records(initial_search)
author_affiliation <- extract_author_affiliations(xml_data)
# Initialize the citations vector
citations <- vector('character', length(author_affiliation))
# Loop through each article to extract relevant details and format the citation
for (ii in seq_along(author_affiliation)) {
article <- author_affiliation[[ii]]
title <- article$title
pmid <- article$pmid
authors_info <- article$authors
# Format author names, bolding those affiliated with the specified institutions or specified names
authors <- sapply(authors_info, function(author) {
name <- paste(author$fore_name, author$last_name)
highlight <- FALSE
if (!is.null(affiliations) && !is.null(author$affiliations) && any(sapply(affiliations, function(aff) any(grepl(aff, author$affiliations))))) {
highlight <- TRUE
}
if (!is.null(highlight_names) && name %in% highlight_names) {
highlight <- TRUE
}
if (highlight) {
name <- paste0("<strong>", name, "</strong>")  # Use HTML for bold text
}
return(name)
})
authors <- paste(authors, collapse = ', ')
# Fetch detailed metadata
publication <- fetch_detailed_metadata(pmid)
pmid_with_text <- glue('PMID: {publication$uid}')
title_hyperlink <- glue('<a href="https://pubmed.ncbi.nlm.nih.gov/{publication$uid}/">{title}</a>')
citation <- paste0(
title_hyperlink, '<br>',
authors, '<br>',
publication$journal, ' ',
publication$epub_date, ' ',
publication$doi, '<br>',
pmid_with_text
)
citations[ii] <- citation
}
return(citations)
}
if (!is.null(doi)) {
all_citations <- vector('list', length(doi))
all_queries <- vector('character', length(doi))
for (i in seq_along(doi)) {
query_term <- paste0(doi[i], "[doi]")
initial_search <- tryCatch({
entrez_search(db = 'pubmed', term = query_term, retmax = max_results, use_history = TRUE)
}, error = function(e) {
message('Error during entrez_search:', '\n', e)
return(NULL)
})
citations <- process_records(initial_search, affiliations, highlight_names)
if (!is.null(citations)) {
all_citations[[i]] <- citations
}
all_queries[i] <- query_term
}
all_citations <- unlist(all_citations, recursive = FALSE)
if (length(all_citations) == 0) {
return(list(citations = "No publications found.", query = all_queries))
} else {
return(list(citations = all_citations, query = all_queries))
}
} else if (!is.null(keywords)) {
current_year <- as.numeric(format(Sys.Date(), "%Y"))
# Initialize search parameters
years <- start_years
records_found <- FALSE
initial_search <- NULL
# Loop through search attempts, incrementing the year range until records are found or the maximum range is reached
while (years <= max_range_years && !records_found) {
query_term <- build_search_query(keywords, affiliations, years)
# Initial search on PubMed
initial_search <- tryCatch({
entrez_search(db = 'pubmed', term = query_term, retmax = max_results, use_history = TRUE)
}, error = function(e) {
message('Error during entrez_search:', '\n', e)
return(NULL)
})
records_found <- (!is.null(initial_search) && length(initial_search$ids) > 0)
if (!records_found) {
years <- years + increment_years
}
}
# Check if no records were found after exhausting the date range
if (is.null(initial_search) || length(initial_search$ids) == 0) {
return(list(citations = paste0('No publications found in the last ', max_range_years, " years."), query = query_term))
}
# Process the records and generate citations
all_citations <- process_records(initial_search, affiliations, highlight_names)
return(list(citations = all_citations, query = query_term))
} else {
stop("Either 'keywords' or 'doi' must be provided.")
}
}
# Fetch and format the citations.
citations <- get_citations(
doi = c("10.1093/jamia/ocae098", "10.14336/AD.2025.0754", "10.1101/2024.10.28.24316286"),
affiliation = c("Yale School of Public Health", "Yale University", "University of Michigan")
)
make_pub_list(citations)
# Fetch and format the citations.
citations <- get_citations(
doi = c("10.1093/jamia/ocae098", "10.14336/AD.2025.0754", "10.1101/2024.10.28.24316286"),
affiliation = c("Yale School of Public Health", "Yale University", "University of Michigan"),
highlight_names = c("Maxwell Salvatore")
)
# Fetch and format the citations.
citations <- get_citations(
doi = c("10.1093/jamia/ocae098", "10.14336/AD.2025.0754", "10.1101/2024.10.28.24316286"),
affiliation = c("Yale School of Public Health", "Yale University"),
highlight_names = c("Maxwell Salvatore")
)
make_pub_list(citations)
# Fetch and format the citations.
citations <- get_citations(
doi = c("10.1093/jamia/ocae098", "10.14336/AD.2025.0754", "10.1101/2024.10.28.24316286",
"10.1101/2023.10.29.564615", "10.1111/dme.15322", "10.1101/2025.06.16.659952"),
affiliation = c("Yale School of Public Health", "Yale University"),
highlight_names = c("Bhramar Mukherjee")
)
# Fetch and format the citations.
citations <- get_citations(
doi = c("10.1093/jamia/ocae098", "10.14336/AD.2025.0754", "10.1101/2024.10.28.24316286",
"10.1101/2023.10.29.564615", "10.1111/dme.15322", "10.1101/2025.06.16.659952"),
affiliation = c("Yale School of Public Health", "Yale University"),
highlight_names = c("Bhramar Mukherjee")
)
make_pub_list(citations)
citations
228 + 27
build_search_query(
keywords = c("Surveillance, Epidemiology, and End Results Program", "NHANES"),
affiliation = "Yale School of Public Health", years = 5)
build_search_query(
keywords = c("National Health and Nutrition Examination Survey", "SEER"),
affiliation = "Yale School of Public Health", years = 5)
build_search_query(
keywords = c("Surveillance, Epidemiology, and End Results Program", "SEER"),
affiliation = "Yale School of Public Health", years = 5)
build_search_query(
keywords = c("National Center for Health Statistics", "NCHS"),
affiliation = "Yale School of Public Health", years = 5)
install.packages("knitr")
install.packages("rmarkdown")
renv::snapshot(prompt = FALSE)
